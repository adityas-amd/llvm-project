// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5
// RUN: %clang_cc1    -fsanitize=alloc-token -triple x86_64-linux-gnu -emit-llvm -disable-llvm-passes %s -o - | FileCheck --check-prefix=CHECK-CODEGEN %s
// RUN: %clang_cc1    -fsanitize=alloc-token -triple x86_64-linux-gnu -emit-llvm                      %s -o - | FileCheck --check-prefix=CHECK-O0 %s
// RUN: %clang_cc1 -O -fsanitize=alloc-token -triple x86_64-linux-gnu -emit-llvm                      %s -o - | FileCheck --check-prefix=CHECK-O1 %s

typedef __typeof(sizeof(int)) size_t;

void *aligned_alloc(size_t alignment, size_t size);
void *malloc(size_t size);
void *calloc(size_t num, size_t size);
void *realloc(void *ptr, size_t size);
void *reallocarray(void *ptr, size_t nmemb, size_t size);
void *memalign(size_t alignment, size_t size);
void *valloc(size_t size);
void *pvalloc(size_t size);
int posix_memalign(void **memptr, size_t alignment, size_t size);

void *sink;

// CHECK-LABEL: @test_malloc_like(
// CHECK-CODEGEN-LABEL: define dso_local void @test_malloc_like(
// CHECK-CODEGEN-SAME: ) #[[ATTR0:[0-9]+]] {
// CHECK-CODEGEN-NEXT:  [[ENTRY:.*:]]
// CHECK-CODEGEN-NEXT:    [[CALL:%.*]] = call ptr @malloc(i64 noundef 4) #[[ATTR6:[0-9]+]]
// CHECK-CODEGEN-NEXT:    store ptr [[CALL]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL1:%.*]] = call ptr @calloc(i64 noundef 3, i64 noundef 4) #[[ATTR7:[0-9]+]]
// CHECK-CODEGEN-NEXT:    store ptr [[CALL1]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[TMP0:%.*]] = load ptr, ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL2:%.*]] = call ptr @realloc(ptr noundef [[TMP0]], i64 noundef 8) #[[ATTR8:[0-9]+]]
// CHECK-CODEGEN-NEXT:    store ptr [[CALL2]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[TMP1:%.*]] = load ptr, ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL3:%.*]] = call ptr @reallocarray(ptr noundef [[TMP1]], i64 noundef 5, i64 noundef 8)
// CHECK-CODEGEN-NEXT:    store ptr [[CALL3]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL4:%.*]] = call align 128 ptr @aligned_alloc(i64 noundef 128, i64 noundef 1024) #[[ATTR8]]
// CHECK-CODEGEN-NEXT:    store ptr [[CALL4]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL5:%.*]] = call align 16 ptr @memalign(i64 noundef 16, i64 noundef 256) #[[ATTR8]]
// CHECK-CODEGEN-NEXT:    store ptr [[CALL5]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL6:%.*]] = call ptr @valloc(i64 noundef 4096)
// CHECK-CODEGEN-NEXT:    store ptr [[CALL6]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL7:%.*]] = call ptr @pvalloc(i64 noundef 8192)
// CHECK-CODEGEN-NEXT:    store ptr [[CALL7]], ptr @sink, align 8
// CHECK-CODEGEN-NEXT:    [[CALL8:%.*]] = call i32 @posix_memalign(ptr noundef @sink, i64 noundef 64, i64 noundef 4)
// CHECK-CODEGEN-NEXT:    ret void
//
// CHECK-O0-LABEL: define dso_local void @test_malloc_like(
// CHECK-O0-SAME: ) #[[ATTR0:[0-9]+]] {
// CHECK-O0-NEXT:  [[ENTRY:.*:]]
// CHECK-O0-NEXT:    [[TMP0:%.*]] = call ptr @__alloc_token_malloc(i64 noundef 4, i64 0) #[[ATTR9:[0-9]+]]
// CHECK-O0-NEXT:    store ptr [[TMP0]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP1:%.*]] = call ptr @__alloc_token_calloc(i64 noundef 3, i64 noundef 4, i64 0) #[[ATTR10:[0-9]+]]
// CHECK-O0-NEXT:    store ptr [[TMP1]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP2:%.*]] = load ptr, ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP3:%.*]] = call ptr @__alloc_token_realloc(ptr noundef [[TMP2]], i64 noundef 8, i64 0) #[[ATTR11:[0-9]+]]
// CHECK-O0-NEXT:    store ptr [[TMP3]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP4:%.*]] = load ptr, ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP5:%.*]] = call ptr @__alloc_token_reallocarray(ptr noundef [[TMP4]], i64 noundef 5, i64 noundef 8, i64 0)
// CHECK-O0-NEXT:    store ptr [[TMP5]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP6:%.*]] = call align 128 ptr @__alloc_token_aligned_alloc(i64 noundef 128, i64 noundef 1024, i64 0) #[[ATTR11]]
// CHECK-O0-NEXT:    store ptr [[TMP6]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP7:%.*]] = call align 16 ptr @__alloc_token_memalign(i64 noundef 16, i64 noundef 256, i64 0) #[[ATTR11]]
// CHECK-O0-NEXT:    store ptr [[TMP7]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP8:%.*]] = call ptr @__alloc_token_valloc(i64 noundef 4096, i64 0)
// CHECK-O0-NEXT:    store ptr [[TMP8]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP9:%.*]] = call ptr @__alloc_token_pvalloc(i64 noundef 8192, i64 0)
// CHECK-O0-NEXT:    store ptr [[TMP9]], ptr @sink, align 8
// CHECK-O0-NEXT:    [[TMP10:%.*]] = call i32 @__alloc_token_posix_memalign(ptr noundef @sink, i64 noundef 64, i64 noundef 4, i64 0)
// CHECK-O0-NEXT:    ret void
//
// CHECK-O1-LABEL: define dso_local void @test_malloc_like(
// CHECK-O1-SAME: ) local_unnamed_addr #[[ATTR0:[0-9]+]] {
// CHECK-O1-NEXT:  [[ENTRY:.*:]]
// CHECK-O1-NEXT:    [[TMP0:%.*]] = tail call dereferenceable_or_null(4) ptr @__alloc_token_malloc(i64 noundef 4, i64 0) #[[ATTR9:[0-9]+]]
// CHECK-O1-NEXT:    store ptr [[TMP0]], ptr @sink, align 8, !tbaa [[TBAA2:![0-9]+]]
// CHECK-O1-NEXT:    [[TMP1:%.*]] = tail call dereferenceable_or_null(12) ptr @__alloc_token_calloc(i64 noundef 3, i64 noundef 4, i64 0) #[[ATTR10:[0-9]+]]
// CHECK-O1-NEXT:    store ptr [[TMP1]], ptr @sink, align 8, !tbaa [[TBAA2]]
// CHECK-O1-NEXT:    [[TMP2:%.*]] = tail call dereferenceable_or_null(8) ptr @__alloc_token_realloc(ptr noundef [[TMP1]], i64 noundef 8, i64 0) #[[ATTR11:[0-9]+]]
// CHECK-O1-NEXT:    store ptr [[TMP2]], ptr @sink, align 8, !tbaa [[TBAA2]]
// CHECK-O1-NEXT:    [[TMP3:%.*]] = tail call dereferenceable_or_null(40) ptr @__alloc_token_reallocarray(ptr noundef [[TMP2]], i64 noundef 5, i64 noundef 8, i64 0)
// CHECK-O1-NEXT:    store ptr [[TMP3]], ptr @sink, align 8, !tbaa [[TBAA2]]
// CHECK-O1-NEXT:    [[TMP4:%.*]] = tail call align 128 dereferenceable_or_null(1024) ptr @__alloc_token_aligned_alloc(i64 noundef 128, i64 noundef 1024, i64 0) #[[ATTR11]]
// CHECK-O1-NEXT:    store ptr [[TMP4]], ptr @sink, align 8, !tbaa [[TBAA2]]
// CHECK-O1-NEXT:    [[TMP5:%.*]] = tail call align 16 dereferenceable_or_null(256) ptr @__alloc_token_memalign(i64 noundef 16, i64 noundef 256, i64 0) #[[ATTR11]]
// CHECK-O1-NEXT:    store ptr [[TMP5]], ptr @sink, align 8, !tbaa [[TBAA2]]
// CHECK-O1-NEXT:    [[TMP6:%.*]] = tail call dereferenceable_or_null(4096) ptr @__alloc_token_valloc(i64 noundef 4096, i64 0)
// CHECK-O1-NEXT:    store ptr [[TMP6]], ptr @sink, align 8, !tbaa [[TBAA2]]
// CHECK-O1-NEXT:    [[TMP7:%.*]] = tail call ptr @__alloc_token_pvalloc(i64 noundef 8192, i64 0)
// CHECK-O1-NEXT:    store ptr [[TMP7]], ptr @sink, align 8, !tbaa [[TBAA2]]
// CHECK-O1-NEXT:    [[TMP8:%.*]] = tail call i32 @__alloc_token_posix_memalign(ptr noundef nonnull @sink, i64 noundef 64, i64 noundef 4, i64 0) #[[ATTR12:[0-9]+]]
// CHECK-O1-NEXT:    ret void
//
void test_malloc_like() {
  sink = malloc(sizeof(int));
  sink = calloc(3, sizeof(int));
  sink = realloc(sink, sizeof(long));
  sink = reallocarray(sink, 5, sizeof(long));
  sink = aligned_alloc(128, 1024);
  sink = memalign(16, 256);
  sink = valloc(4096);
  sink = pvalloc(8192);
  posix_memalign(&sink, 64, sizeof(int));
}

// CHECK-LABEL: @no_sanitize_malloc(
// CHECK-CODEGEN-LABEL: define dso_local ptr @no_sanitize_malloc(
// CHECK-CODEGEN-SAME: i64 noundef [[SIZE:%.*]]) #[[ATTR5:[0-9]+]] {
// CHECK-CODEGEN-NEXT:  [[ENTRY:.*:]]
// CHECK-CODEGEN-NEXT:    [[SIZE_ADDR:%.*]] = alloca i64, align 8
// CHECK-CODEGEN-NEXT:    store i64 [[SIZE]], ptr [[SIZE_ADDR]], align 8
// CHECK-CODEGEN-NEXT:    [[TMP0:%.*]] = load i64, ptr [[SIZE_ADDR]], align 8
// CHECK-CODEGEN-NEXT:    [[CALL:%.*]] = call ptr @malloc(i64 noundef [[TMP0]]) #[[ATTR6]]
// CHECK-CODEGEN-NEXT:    ret ptr [[CALL]]
//
// CHECK-O0-LABEL: define dso_local ptr @no_sanitize_malloc(
// CHECK-O0-SAME: i64 noundef [[SIZE:%.*]]) #[[ATTR8:[0-9]+]] {
// CHECK-O0-NEXT:  [[ENTRY:.*:]]
// CHECK-O0-NEXT:    [[SIZE_ADDR:%.*]] = alloca i64, align 8
// CHECK-O0-NEXT:    store i64 [[SIZE]], ptr [[SIZE_ADDR]], align 8
// CHECK-O0-NEXT:    [[TMP0:%.*]] = load i64, ptr [[SIZE_ADDR]], align 8
// CHECK-O0-NEXT:    [[CALL:%.*]] = call ptr @malloc(i64 noundef [[TMP0]]) #[[ATTR9]]
// CHECK-O0-NEXT:    ret ptr [[CALL]]
//
// CHECK-O1-LABEL: define dso_local noalias noundef ptr @no_sanitize_malloc(
// CHECK-O1-SAME: i64 noundef [[SIZE:%.*]]) local_unnamed_addr #[[ATTR2:[0-9]+]] {
// CHECK-O1-NEXT:  [[ENTRY:.*:]]
// CHECK-O1-NEXT:    [[CALL:%.*]] = tail call ptr @malloc(i64 noundef [[SIZE]]) #[[ATTR9]]
// CHECK-O1-NEXT:    ret ptr [[CALL]]
//
void *no_sanitize_malloc(size_t size) __attribute__((no_sanitize("alloc-token"))) {
  return malloc(size);
}
//.
// CHECK-O1: [[TBAA2]] = !{[[META3:![0-9]+]], [[META3]], i64 0}
// CHECK-O1: [[META3]] = !{!"any pointer", [[META4:![0-9]+]], i64 0}
// CHECK-O1: [[META4]] = !{!"omnipotent char", [[META5:![0-9]+]], i64 0}
// CHECK-O1: [[META5]] = !{!"Simple C/C++ TBAA"}
//.
